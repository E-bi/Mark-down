## æ•°æ®åº“çš„åŸºæœ¬æ“ä½œ

---

* CRUD å¢åˆ æ”¹æŸ¥: create read update delete



## ç®¡ç†å™¨å¯¹è±¡

---

* æ¯ä¸ªç»§æ‰¿è‡ª models.Model çš„æ¨¡å‹ç±», éƒ½ä¼šæœ‰ä¸€ä¸ªobjects å¯¹è±¡å‘—åŒæ ·ç»§æ‰¿ä¸‹æ¥. è¿™ä¸ªå¯¹è±¡å«ç®¡ç†å™¨å¯¹è±¡

* æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥å¯ä»¥é€šè¿‡æ¨¡å‹çš„ç®¡ç†å™¨å®ç°

  ```python
  class MyModel(models.Model):
  		...
  MyModel.objects.create() # objects æ˜¯ç®¡ç†å™¨å¯¹è±¡
  
  Book.objects.create(title=, pub=, price=, market=)
  ```



## åˆ›å»ºæ•°æ®å¯¹è±¡

---

* Django æŠŠæ•°æ®åº“ä¸­çš„æ•°æ®, ç›´è§‚è¡¨ç¤ºæˆPythonå¯¹è±¡

* åˆ›å»ºæ•°æ®ä¸­æ¯ä¸€æ¡è®°å½•, å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ•°æ®å¯¹è±¡

  ```python
  1. 
  MyModel.objects.create(å±æ€§1=å€¼1, å±æ€§2=å€¼2)
  # æˆåŠŸ: è¿”å›ä¼ å»ºå¥½çš„å®ä½“å¯¹è±¡  å¤±è´¥: æŠ›å‡ºå¼‚å¸¸
  ```

  ```python
  2. åˆ›å»ºMyModelå®ä¾‹å¯¹è±¡, å¹¶è°ƒç”¨save()è¿›è¡Œä¿å­˜
  obj = MyModel(å±æ€§=å€¼, å±æ€§=å€¼)
  obj.å±æ€§ = å€¼
  obj.save()
  # æ— è¿”å›å€¼,ä¿å­˜æˆåŠŸå,objä¼šè¢«é‡æ–°èµ‹å€¼
  ```



## Django shell çš„ä½¿ç”¨

---

* Djangoæä¾›çš„äº¤äº’å¼æ“ä½œé¡¹ç›®: Django shell èƒ½å¤Ÿåœ¨äº¤äº’æ¨¡å¼, ç”¨é¡¹ç›®å·¥ç¨‹çš„ä»£ç æ‰§è¡Œç›¸åº”çš„æ“ä½œ

* å¯ä»¥ä»£æ›¿ç¼–å†™Viewçš„ä»£ç , ç›´æ¥æ“ä½œ

* Django shell ä¸‹åªèƒ½ç®€å•æ“ä½œ, ä¸èƒ½è¿è¡Œè¿œç¨‹è°ƒè¯•

* å¯åŠ¨æ–¹å¼

  ```python
  python3 manage.py shell
  ```

* ç»ƒä¹ 

  ```shell
  from book.models import Book
  obj = Book.objects.create(å±æ€§=å€¼,å±æ€§=å€¼)
  ```



## æŸ¥è¯¢æ•°æ®

é€šè¿‡MyModel.objects ç®¡ç†å™¨æ–¹æ³•è°ƒç”¨æŸ¥è¯¢æ¥å£

```python
MyModel.objects.all() # æŸ¥è¯¢å…¨éƒ¨è®°å½•,è¿”å›QuerySetæŸ¥è¯¢å¯¹è±¡
get() # æŸ¥è¯¢å‘ä¸ªæ¡ä»¶çš„å•ä¸€è®°å½•
filter() # æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å¤šæ¡è®°å½•
exclude() # æŸ¥è¯¢ç¬¦åˆæ¡ä»¶ä¹‹å¤–çš„å…¨éƒ¨è®°å½•
......
```

1. ##### all()  =  select * from table

   è¿”å›å€¼: QuerySet å®¹å™¨å¯¹è±¡, å†…éƒ¨å­˜æ”¾MyModelå®ä¾‹

   ```
   from bookstore.models import book
   books = book.objects.all()
   for i in books:
   		print(i.å­—æ®µå1, i.å­—æ®µå2, ....)
   ```

   tips: åœ¨æ¨¡å‹ç±»ä¸­å®šä¹‰ def \__str__(self): æ–¹æ³•å¯ä»¥å°†è‡ªå®šä¹‰é»˜è®¤çš„å­—ç¬¦

   ```python
   def __str__(self):
   		return self.å±æ€§å
   		
   		return 'ä¹¦å: %s, å‡ºç‰ˆç¤¾: '%s, å®šä»·: %s' % (self.å±æ€§å,self.å­—æ®µå) 
       # å±æ€§==å­—æ®µå
   ```

2. ##### values() = select å­—æ®µ1,å­—æ®µ2 from table

   æŸ¥è¯¢è¿”å›æŒ‡å®šåˆ—( å­—å…¸è¡¨ç¤º )

   ```python
   MyModel.objects.values()
   # æŸ¥è¯¢éƒ¨åˆ†åˆ—çš„æ•°æ®å¹¶è¿”å›
   # è¿”å›å€¼: QuerySet
   {'åˆ—1':å€¼1,'åˆ—2':å€¼2}
   
   from bookstore.models import Book
   books = book.objects.values('title','pub') # æŸ¥è¯¢titleå­—æ®µ,pubå­—æ®µ
   for i in books:
     	print('ä¹¦å:',i['title'],'å‡ºç‰ˆç¤¾:',i['pub'])
   ```

3. #####  value_list('åˆ—1','åˆ—2)

   è¿”å›æŒ‡å®šåˆ—()

   ```python
   MyModel.objects.values_list(...)
   # è¿”å›å…ƒç¥–å½¢å¼çš„æŸ¥è¯¢ç»“æœ
   # è¿”å›å€¼: QuerySetå®¹å™¨å¯¹è±¡,å†…éƒ¨å­˜æ”¾å…ƒç»„,ä¼šå°†æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®å°è£…åˆ°å…ƒç¥–ä¸­,åœ¨å°è£…åˆ°æŸ¥è¯¢é›†åˆQuerySetä¸­
   
   from bookstore.models import Book
   books = Book.objects.values_list('title','pub') # æŸ¥è¯¢titleå­—æ®µ,pubå­—æ®µ
   for i in books:
   		print(i)
   ```

4. ##### order_by  == order by

   æ’åºæŸ¥è¯¢

   ```python
   MyModel.objects.order_by('-åˆ—','åˆ—')
   # è¿”å›çš„æ˜¯å¯¹è±¡
   # æ ¹æ®æŸä¸ªå­—æ®µè¿›è¡Œæ’åº, å¦‚æœæ˜¯é™åºå°±åœ¨å‰é¢åŠ -
   
   from bookstore.models import Book
   books = Book.objects.order_by('price')
   for i in books:
   		print(i.title, i.price)
   ```

5. ##### filter(æ¡ä»¶)

   æ ¹æ®æ¡ä»¶æŸ¥è¯¢å¤šæ¡è®°å½•

   ```python
   MyModel.objects.filter(å±æ€§1=å€¼1,å±æ€§2=å€¼2)
   # QuerySetå®¹å™¨å¯¹è±¡,å†…éƒ¨å­˜æ”¾MyModelå®ä¾‹
   
   # å¤šä¸ªå±æ€§,å°±æ˜¯'ä¸'å…³ç³»,å³
   Books.objects.filter(price=20,pub='æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾')
   # è¿”å›å®šä»·ä¸º20 ä¸” å‡ºç‰ˆç¤¾ä¸º'æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾' çš„å¯¹è±¡
   
   from bookstore.models import Book
   books = Book.objects.filter(pub='æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾')
   for i in books:
     	print(i.title)
   ```

6. Tips: éç­‰å€¼æ¡ä»¶æ„å»º

   ```python
   # æŸ¥è¯¢ä½œè€…è¡¨ä¸­å¹´é¾„å¤§äº30
   Author.objects.filter(age__gt=30)
   
   # å¯¹åº” select * table where age > 30;
   ```

7. ##### exclude(æ¡ä»¶)

   ```python
   books = models.Book.objects.exclude(pub='æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾',price__gt=50)
   for i in books:
     	print(i)
   ```

8. ##### get(æ¡ä»¶)

   ```python
   MyModel.objects.get(æ¡ä»¶)
   # è¿”å›æ»¡è¶³æ¡ä»¶çš„å”¯ä¸€ä¸€æ¡æ•°æ®
   # å¦‚æœæ•°æ®å¤šäº1æ¡,æŠ›å‡ºModel.MultipleObjectsReturnedå¼‚å¸¸# 
   # æ²¡ç»“æœæŠ›å‡ºModel.DoesNotExistå¼‚å¸¸
   # è¿”å›å€¼ MyModelå¯¹è±¡
   ```

   



## æŸ¥è¯¢è°“è¯

æ¯ä¸€ä¸ªæŸ¥è¯¢è°“è¯æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢åŠŸèƒ½

---

1. \__exact : ç­‰å€¼åŒ¹é…

   ```python
   Author.objects.filter(id__exact=1)
   # å¯¹åº” select * from author where id = 1;
   ```

2. \__contains : åŒ…å«æŒ‡å®šå€¼

   ```python
   Author.objects.filter(name__contains='w')
   # select * from author where name like '%w%';
   ```

3. \__startswith : ä»¥XXå¼€å§‹

4. \__endswith : ä»¥XXç»“å°¾

5. \__gt : å¤§äºæŒ‡å®šå€¼

6. \__gte : å¤§äºç­‰äº

7. \__lt : å°äº

8. \__lte : å°äºç­‰äº

9. \__in : æŸ¥æ‰¾æ•°æ®æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…

   ```python
   Author.objects.filter(country__in=['ä¸­å›½','æ—¥æœ¬','éŸ©å›½'])
   # select * from author where country in ('ä¸­å›½','æ—¥æœ¬','éŸ©å›½')
   ```

10. \__range : æŸ¥æ‰¾æ•°æ®æ˜¯å¦åœ¨æŒ‡å®šçš„åŒºé—´èŒƒå›´å†…

    ```python
    Author.objects.filter(age__range=(35,50))
    # select * from author where age between 35 and 50);
    ```

å®˜ç½‘ç›®å½•: https://docs.djangoproject.com/en/2.2/ref/models/querysets/#field-lookups



## ä¿®æ”¹æ•°æ®è®°å½•

---

1. ä¿®æ”¹å•ä¸ªå®ä½“çš„æŸäº›å­—æ®µå€¼çš„æ­¥éª¤:

   1. æŸ¥: é€šè¿‡ get()å¾—åˆ°è¦ä¿®æ”¹çš„å®ä½“å¯¹è±¡
   2. æ”¹: é€šè¿‡ å¯¹è±¡.å±æ€§çš„æ–¹å¼ä¿®æ”¹æ•°æ®
   3. å­˜: é€šè¿‡ å¯¹è±¡.save()ä¿å­˜æ•°æ®

   ```python
   from bookstore.models import Book
   abook = Book.objects.get(id=10)
   abook.market_price='10.5'
   abook.save()
   ```

2. é€šè¿‡ QuerySet æ‰¹é‡ä¿®æ”¹ å¯¹åº”çš„å…¨éƒ¨å­—æ®µ

   ç›´æ¥è°ƒç”¨QuerySetçš„ update(å±æ€§=å€¼) å®ç°æ‰¹é‡ä¿®æ”¹

   ```python
   # å°†idå¤§äº3çš„æ‰€æœ‰å›¾ä¹¦ä»·æ ¼å®šä½0å…ƒ
   books = Book.objects.filter(id__gt=3)
   books.update(market_price=3)
   books.save()
   
   # å°†æ‰€æœ‰ä¹¦å®šä»·ä¸º0å…ƒ
   books = Book.objects.all()
   books.update(market_price=0)
   books.save()
   ```



## åˆ é™¤è®°å½•

æŸ¥è¯¢ç»“æœé›†QuerySet ä¸­çš„å…¨éƒ¨å¯¹è±¡, éƒ½æ˜¯è°ƒç”¨delete()æ–¹æ³•

---

1. åˆ é™¤å•ä¸ªå¯¹è±¡

   1. æŸ¥æ‰¾æŸ¥è¯¢ç»“æœå¯¹åº”çš„ä¸€ä¸ªæ•°æ®å¯¹è±¡
   2. è°ƒç”¨è¿™ä¸ªæ•°æ®å¯¹è±¡çš„delete()æ–¹æ³•å®ç°åˆ é™¤

   ```
   try:
   		auth = Author.objects.get(id=1)
   		auth.delete()
   except:
   		print('åˆ é™¤å¤±è´¥')
   ```

2. åˆ é™¤æŸ¥è¯¢ç»“æœé›†
   1. æŸ¥è¯¢æ»¡è¶³çš„å…¨éƒ¨QuerySetæŸ¥è¯¢é›†åˆå¯¹è±¡
   2. è°ƒç”¨delete()æ–¹æ³•åˆ é™¤
3. ä¼ªåˆ é™¤



## èšåˆæŸ¥è¯¢

å¯¹è¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µæ•°æ®è¿›è¡Œéƒ¨åˆ†æˆ–å…¨éƒ¨è¿›è¡Œç»Ÿè®¡æŸ¥è¯¢( ç»Ÿè®¡,å¹³å‡ç­‰)

---

1. ä¸å¸¦åˆ†ç»„èšåˆ

   ```python
   from django.db.models import *
   Sum Avg Count Max Min
   
   MyModel.objects.aggregate(ç»“æœå˜é‡å=èšåˆå‡½æ•°('åˆ—'))
   
   # è¿”å›ç»“æœ:
   # ç”±ç»“æœå˜é‡åå’Œå€¼ç»„æˆçš„å­—å…¸
   # æ ¼å¼ä¸º:
   {'ç»“æœå˜é‡å':å€¼} (c=max(price) -> {'c':1111})
   
   from bookstore.models import Book
   from django.db.models import Count
   res = Book.objects.aggregate(myAvg=Avg('price'))
   print('å¹³å‡ä»·æ ¼æ˜¯:', res['myAvg'])
   print(res)  ->  {'myAvg':58.2}
   
   ```

2. åˆ†ç»„èšåˆ

   é€šè¿‡è®¡ç®—æŸ¥è¯¢ç»“æœ, ä¸­æ¯ä¸€ä¸ªå¯¹è±¡æ‰€å…³è”çš„å¯¹è±¡é›†åˆ, ä»è€Œå¾—å‡ºæ€»è®¡å€¼( å¯ä»¥æ˜¯å¹³å‡å€¼æˆ–è€…æ€»å’Œ ), å³ä¸ºæŸ¥è¯¢é›†çš„æ¯ä¸€é¡¹ç”Ÿæˆèšåˆ

   ```python
   QuerySet.annotate(ç»“æœå˜é‡å=èšåˆå‡½æ•°('åˆ—'))
   
   # MyModel.objects.value('åˆ—1','åˆ—2')
   res = Books.objects.values('pub')
   
   pub_count_set = res.annotate(myCount=Count('pub'))
   print('pub_count_set') # <QuerySet [{}]
   ```



## Få¯¹è±¡

ä¸€ä¸ªFå¯¹è±¡ä»£è¡¨æ•°æ®åº“ä¸­æŸæ¡è®°å½•çš„å­—æ®µçš„ä¿¡æ¯

---

é€šå¸¸æ˜¯å¯¹æ•°æ®åº“ä¸­çš„å­—æ®µå€¼åœ¨ä¸è·å–çš„æƒ…å†µä¸‹è¿›è¡Œæ“ä½œ

ç”¨äºå±æ€§ç±»(å­—æ®µä¹‹é—´çš„æ¯”è¾ƒ)

```python
from django.db.models import F
F('åˆ—å')

models.Book.objects.all().update(market_price=F('market_price')+10) # åˆ©ç”¨Få¯¹è±¡æ›´æ–°æ•°æ®åº“

# æŸ¥è¯¢å”®ä»·å¤§äºå®šä»·
Book.objects.fiter(market_price__gt=F('price'))
```

Tips: 

```
obj.query #å¯ä»¥çœ‹å‡ºä½ å¾—åˆ°çš„å¯¹è±¡æ˜¯ä»€ä¹ˆ
```



## å¿…æ€æŠ€

1. print(QuerySet.query) å¯æŸ¥çœ‹å½“å‰ormè¯­å¥å…·ä½“æ‰§è¡Œçš„Sqlè¯­å¥



## Qå¯¹è±¡

å½“åœ¨è·å–æŸ¥è¯¢ç»“æœé›† ä½¿ç”¨å¤æ‚çš„é€»è¾‘ |  ~ ç­‰æ“ä½œ, å¯ä»¥å€ŸåŠ©Qå¯¹è±¡

---

æ‰¾å‡ºå®šä»·ä½äº20 å…ƒ æˆ– æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾ çš„å…¨éƒ¨ä¹¦

```python
from django.db.models import Q
models.Book.objects.filter(Q(price__lt=20)|Q(pub='æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾'))

Q(æ¡ä»¶1)|Q(æ¡ä»¶2)
Q(æ¡ä»¶1)&Q(æ¡ä»¶2)
Q(æ¡ä»¶1)&~(æ¡ä»¶2) # é
```



## åŸç”Ÿçš„æ•°æ®åº“æ“ä½œæ–¹æ³•

åªè¦æ¶‰åŠåˆ°ç”¨sqlåŸç”Ÿè¯­å¥ç›´æ¥æ“ä½œæ•°æ®åº“çš„è¡Œä¸º, åˆ‡è®°ä½¿ç”¨ç”¨æˆ·çš„è¾“å…¥å€¼ç›´æ¥è¿›è¡ŒSQLè¯­å¥çš„æ ¼å¼åŒ–, å¦åˆ™ä¼šé­å—SQLæ³¨å…¥æ”»å‡»

---

```python
MyModel.objects.raw(sqlè¯­å¥)
book = models.Book.objects.raw('select * from bookstore_book')

# è¿”å›RawQuerySet é›†åˆå¯¹è±¡[åªæ”¯æŒåŸºç¡€æ“ä½œ, æ¯”å¦‚å¾ªç¯]
```



ç”¨åˆ›å»ºcursorç±»çš„æ„é€ å‡½æ•°åˆ›å»ºcursorå¯¹è±¡, åœ¨ä½¿ç”¨cursorå¯¹è±¡, ä¸ºä¿è¯åœ¨å‡ºç°å¼‚å¸¸æ—¶èƒ½é‡Šæ”¾cursorèµ„æº, é€šå¸¸ä½¿ç”¨withè¯­å¥è¿›è¡Œåˆ›å»ºæ“ä½œ

```python
from django.db import connection
with connection.cursor() as cur:
  	cur.execute('sqlè¯­å¥')
    
with connection.cursor() as cur:
  	cur.execute('update bookstore_book set pub="xxxå‡ºç‰ˆç¤¾ where id=10")
```



## admin åå°æ•°æ®åº“ç®¡ç†

Django æä¾›äº†å®Œå–„çš„åå°æ•°æ®åº“çš„æ¥å£, å¯ä¾›å¼€å‘è¿‡ç¨‹ä¸­è°ƒç”¨å’Œæµ‹è¯•ä½¿ç”¨

djangoä¼šæ”¶é›†æ‰€æœ‰å·²æ³¨å†Œçš„æ¨¡å‹ç±», ä¸ºè¿™äº›æ¨¡å‹ç±»æä¾›æ•°æ®ç®¡ç†ç•Œé¢, ä¾›å¼€å‘è€…ä½¿ç”¨

ä½¿ç”¨æ­¥éª¤:

```shell
1. åˆ›å»ºåå°ç®¡ç†è´¦å·:
$ python3 manage.py createsuperuser
2. æ ¹æ®æç¤ºå®Œæˆæ³¨å†Œ,å‚è€ƒå¦‚ä¸‹:
Username(leave blank to use 'tarena'): tarena # æ­¤å¤„è¾“å…¥ç”¨æˆ·å
Email address: allen@qq.com # æ­¤å¤„è¾“å…¥é‚®ç®±,å¯å›è½¦è·³è¿‡
Password(again): # å†æ¬¡è¾“å…¥é‡å¤å¯†ç 
Superuser created successfully.
```

ç™»å½•: http://127.0.0.1/admin



* æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹ç±»çš„åå°ç®¡ç†æ•°æ®è¡¨, é…ç½®æ–¹æ³•å¦‚ä¸‹

1. åœ¨åº”ç”¨appä¸­çš„admin.pyä¸­å¯¼å…¥æ³¨å†Œè¦ç®¡ç†çš„æ¨¡å‹modelsç±», å¦‚:

   ```python
   from . import models
   ```

2. è°ƒç”¨admin.site.tegisteræ–¹æ³•è¿›è¡Œæ³¨å†Œ:

   ```python
   from django.contrib import admin
   admin.site.register(è‡ªå®šä¹‰æ¨¡å‹ç±»)
   ```

åœ¨bookstore/admin.pyæ·»åŠ ä»£ç å¯¹Bookç±»è¿›è¡Œç®¡ç†

```python
# file: bookstore/admin.py
from .models import Book
admin.site.register(Book)
```



## ä¿®æ”¹åå°Modelsçš„å±•ç¤ºå½¢å¼

* åœ¨adminåå°ç®¡ç†æ•°æ®åº“ä¸­, è‡ªå®šä¹‰çš„æ•°æ®è®°å½•éƒ½å±•ç¤ºä½ xxxx objectç±»å‹çš„è®°å½•, ä¸ä¾¿äºé˜…è¯»å’Œåˆ¤æ–­

* åœ¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ¨¡å‹ç±»ä¸­å¯ä»¥é‡å†™ def \__str__(self): æ–¹æ³•è§£å†³ç°å®é—®é¢˜

  ```
  class Book(models.Model):
  		...
  		def __str__(self):
  				return self.title # å±•ç¤ºæƒ³è¦å±•ç¤ºçš„å±æ€§
  ```

  

## æ¨¡å‹ç®¡ç†å™¨ç±»

ä¸ºåå°ç®¡ç†ç•Œé¢æ·»åŠ ä¾¿äºæ“ä½œçš„æ–°åŠŸèƒ½

tip: åå°ç®¡ç†å™¨ç±»éœ€ç»§æ‰¿è‡ª django.contrib.admin é‡Œçš„ ModelAdmin ç±»



* ##### æ¨¡å‹ç®¡ç†å™¨çš„ä½¿ç”¨æ–¹æ³•:

1. åœ¨ <åº”ç”¨app>/admin.py é‡Œå®šä¹‰æ¨¡å‹ç®¡ç†å™¨ç±»:

```python
class XXXX_Manager(admin.ModelAdmin):
		......
```

2. æ³¨å†Œç®¡ç†å™¨ä¸æ¨¡å‹ç±»å…³è”

```python
from django.contrib import admin
from . import models
admin.site.register(models.YYYY, XXXX_Manager)
# æ³¨å†Œmodels.YYYæ¨¡å‹ç±» ä¸ ç®¡ç†å™¨ç±»XXXX_Manager å…³è”


# file:bookstore/admin.py
from django.contrib import admin
from . import models
class BookAdmin(admin.ModelAdmin):
  	list_display = ['id','title','price']
admin.site.register(models.Book, BookAdmin)

#è¿™æ ·åœ¨adminé¡µé¢Bookç±»é‡Œé¢æ˜¾ç¤º å°±æœ‰id title price 3ä¸ª, åŸæœ¬é»˜è®¤åªæ˜¾ç¤ºä¸€ä¸ª
```



* ##### æ¨¡å‹ç±»ç®¡ç†å™¨ModelAdminä¸­å®ç°çš„é«˜çº§ç®¡ç†åŠŸèƒ½

1. list_display å»æ§åˆ¶å“ªäº›å­—æ®µä¼šæ˜¾ç¤ºåœ¨ admin çš„ä¿®æ”¹åˆ—è¡¨é¡µé¢ä¸­   (é¦–é¡µ- åˆ—è¡¨é¡µ - è¯¦æƒ…é¡µ)

2. list_display_links å¯ä»¥æ§åˆ¶ list_display ä¸­çš„å­—æ®µæ˜¯å¦åº”è¯¥è¿æ¥åˆ°å¯¹è±¡çš„ 'æ›´æ”¹(è¯¦æƒ…é¡µ)' é¡µé¢

3. list_filter è®¾ç½®æ¿€æ´» admin ä¿®æ”¹åˆ—è¡¨é¡µé¢å³ä¾§æ ä¸­çš„è¿‡æ»¤å™¨

4. search_fields è®¾ç½®å¯ç”¨ admin æ›´æ”¹åˆ—è¡¨é¡µé¢ä¸Šçš„æœç´¢æ¡†

5. list_editable è®¾ç½®ä¸ºæ¨¡å‹ä¸Šçš„å­—æ®µåç§°åˆ—è¡¨, è¿™å°†å…è®¸åœ¨æ›´æ”¹åˆ—è¡¨é¡µé¢ä¸Šè¿›è¡Œç¼–è¾‘

   ```python
   list_display = ['id','title','price'] # æ ·å¼
   ```

6. å…¶ä»–å‚è§:  https://docs.djangoproject.com/en/2.2/ref/contrib/admin/



## æ•°æ®åº“è¡¨ç®¡ç†

1. ä¿®æ”¹æ¨¡å‹ç±»å­—æ®µçš„æ˜¾ç¤ºåå­—

   * æ¨¡å‹ç±»ä¸ªå­—æ®µçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º verbose_name, æ­¤å­—æ®µæ˜¾ç¤ºçš„åå­—ä¼šåœ¨åå°æ•°æ®åº“ç®¡ç†é¡µé¢æ˜¾ç¤º

   * é€šè¿‡ verbose_name å­—æ®µé€‰é¡¹, ä¿®æ”¹æ˜¾ç¤ºåç§°ç¤ºä¾‹å¦‚ä¸‹: 

     ```python
     title = models.CharField(max_length=30, verbose_name='æ˜¾ç¤ºåç§°')
     ```

2. é€šè¿‡Metaå†…åµŒç±» å®šä¹‰æ¨¡å‹ç±»çš„å±æ€§åŠå±•ç°å½¢å¼

   * æ¨¡å‹ç±»å¯ä»¥é€šè¿‡å®šä¹‰å†…éƒ¨ç±» class Meta æ¥é‡æ–°å®šä¹‰å½“å‰æ¨¡å‹ç±»å’Œæ•°æ®è¡¨çš„ä¸€äº›å±æ€§ä¿¡æ¯

   ```python
   class Book(models.Model):
   		title = CharField(...)
   		class Meta:
   				1. db_table = 'æ•°æ®è¡¨å'
   					- è¯¥æ¨¡å‹æ‰€ç”¨çš„æ•°æ®è¡¨çš„åç§°. (è®¾ç½®å®Œæˆåéœ€è¦ç«‹é©¬æ›´æ–°åŒæ­¥æ•°æ®åº“)
           2. verbose_name = 'å•æ•°å'
           	- ç»™æ¨¡å‹å¯¹è±¡çš„ä¸€ä¸ªæ˜“äºç†è§£çš„åç§°,ç”¨äºæ˜¾ç¤ºåœ¨/admin ç®¡ç†ç•Œé¢ä¸­
           3. verbose_name_plural = 'å¤æ•°å'
           	- ç»™æ¨¡å‹å¯¹è±¡çš„ä¸€ä¸ªæ˜“äºç†è§£çš„åç§°(è´Ÿæ•°),ç”¨äºæ˜¾ç¤ºåœ¨/admin ç®¡ç†ç•Œé¢ä¸­
             
   ä¿®æ”¹å:
   python3 manage.py makemigrations
   python3 manage.py migrate
   ```

   

## æ•°æ®è¡¨å…³è”å…³ç³»æ˜ å°„

* åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­, é€šå¸¸ä¸ä¼šå§æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨åŒä¸€å¼ è¡¨ä¸­, è¿™æ ·ä¼šé¢å¤–çš„å ç”¨å†…å­˜ç©ºé—´
* å…³ç³»ç³»åˆ—æ•°æ®åº“ä¸­, é€šå¸¸ç”¨è¡¨å…³è”æ¥è§£å†³æ•°æ®åº“

### ä¸€å¯¹ä¸€æ˜ å°„

*  è¯­æ³•

  ```python
  class A(models.Model):
  		pass
  class B(models.Model):
      å±æ€§ = models.OneToOneField(A)
      
  # file: xxxxx/models.py
  from django.db import models
  class Author(models.Model):
    	'''ä½œå®¶æ¨¡å‹ç±»'''
      name = models.CharField('ä½œå®¶',max_length=50)
  class Wife(models.Model):
    	'''ä½œå®¶å¦»å­ç±»'''
      Author = models.OneToOneField(Author)
      # django2.2.8 éœ€è¦on_deleteè®¾ç½®
      Author = models.OnetoOneField(Author, on_delete=models.CASCADE)
  ```

  ```python
  å½“æ‰§è¡Œ python manage.py makemigrations å‡ºç°é”™è¯¯ï¼šTypeError: init() missing 1 required positional argument: â€˜on_deleteâ€™
  
  è§£å†³æ–¹æ¡ˆï¼š
  å®šä¹‰å¤–é”®çš„æ—¶å€™éœ€è¦åŠ ä¸Š on_delete=;
  å³ï¼šcontract = models.ForeignKey(Contract, on_delete=models.CASCADE)
  
  åŸå› å¦‚ä¸‹ï¼š
  django å‡çº§åˆ°2.0ä¹‹å,è¡¨ä¸è¡¨ä¹‹é—´å…³è”çš„æ—¶å€™,å¿…é¡»è¦å†™on_deleteå‚æ•°,å¦åˆ™ä¼šæŠ¥å¼‚å¸¸:
  TypeError: init() missing 1 required positional argument: â€˜on_deleteâ€™
  
  on_delete=None, # åˆ é™¤å…³è”è¡¨ä¸­çš„æ•°æ®æ—¶,å½“å‰è¡¨ä¸å…¶å…³è”çš„fieldçš„è¡Œä¸º
  on_delete=models.CASCADE, # åˆ é™¤å…³è”æ•°æ®,ä¸ä¹‹å…³è”ä¹Ÿåˆ é™¤
  on_delete=models.DO_NOTHING, # åˆ é™¤å…³è”æ•°æ®,ä»€ä¹ˆä¹Ÿä¸åš
  on_delete=models.PROTECT, # åˆ é™¤å…³è”æ•°æ®,å¼•å‘é”™è¯¯ProtectedError
  # models.ForeignKey('å…³è”è¡¨', on_delete=models.SET_NULL, blank=True, null=True)
  on_delete=models.SET_NULL, # åˆ é™¤å…³è”æ•°æ®,ä¸ä¹‹å…³è”çš„å€¼è®¾ç½®ä¸ºnullï¼ˆå‰æFKå­—æ®µéœ€è¦è®¾ç½®ä¸ºå¯ç©º,ä¸€å¯¹ä¸€åŒç†ï¼‰
  # models.ForeignKey('å…³è”è¡¨', on_delete=models.SET_DEFAULT, default='é»˜è®¤å€¼')
  on_delete=models.SET_DEFAULT, # åˆ é™¤å…³è”æ•°æ®,ä¸ä¹‹å…³è”çš„å€¼è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼ˆå‰æFKå­—æ®µéœ€è¦è®¾ç½®é»˜è®¤å€¼,ä¸€å¯¹ä¸€åŒç†ï¼‰
  on_delete=models.SET, # åˆ é™¤å…³è”æ•°æ®,
  a. ä¸ä¹‹å…³è”çš„å€¼è®¾ç½®ä¸ºæŒ‡å®šå€¼,è®¾ç½®ï¼šmodels.SET(å€¼)
  b. ä¸ä¹‹å…³è”çš„å€¼è®¾ç½®ä¸ºå¯æ‰§è¡Œå¯¹è±¡çš„è¿”å›å€¼,è®¾ç½®ï¼šmodels.SET(å¯æ‰§è¡Œå¯¹è±¡)
  ```

* #### è·å–å…³è”çš„æ•°æ®

  æ­£å‘æŸ¥è¯¢

  ```python
  # é€šè¿‡ wife æ‰¾ author
  from . import models
  wife = models.Wife.objects.get(name='ç‹å¤«äºº')
  print(wife.name, 'çš„è€å…¬æ˜¯', wife.author.name)
  ```

  åå‘æŸ¥è¯¢

  ```python
  # é€šè¿‡ author.wife å…³è”å±æ€§ æ‰¾ wife,å¦‚æœæ²¡æœ‰å¯¹åº”çš„wifeåˆ™è§¦å‘å¼‚å¸¸
  author1 = models.Author.objects.get(name='ç‹è€å¸ˆ')
  print(author1.name, 'çš„å¦»å­æ˜¯', author1.wife.name)
  author2 = models.Author.objects.get(name='å°æ³½è€å¸ˆ')
  try:
      print(author2.name, 'çš„å¦»å­æ˜¯', author2.wife.name)
  except:
      print(author2.name, 'è¿˜æ²¡æœ‰å¦»å­')
  ```

  

### ä¸€å¯¹å¤šæ˜ å°„

* è¯­æ³•

  ```python
  class A(models.Model):
  		pass
  class B(models.Model):
  		å±æ€§ = models.ForeignKey(å¤šå¯¹ä¸€ä¸­çš„'ä¸€'çš„æ¨¡å‹ç±», ...)
  ```

* å¤–é”®ç±»ForeignKey

  æ„é€ å‡½æ•°

  ```python
  ForeignKey(to, on_delete, **options)
  # **options` å¯ä»¥æ˜¯å¸¸ç”¨çš„å­—æ®µé€‰é¡¹å¦‚:
          1. null
          2. uniqueç­‰ 
  ```

  å¸¸ç”¨å‚æ•°:

  ```python
  # on_delete
  1. models.CASCADE çº§è”åˆ é™¤. Djangoæ¨¡æ‹Ÿ!!! SQLçº¦æŸON DELETE CASCADEçš„è¡Œä¸º,å¹¶åˆ é™¤åŒ…å«ForeignKeyçš„å¯¹;  mysql é»˜è®¤æ˜¯ä»è¡¨æœ‰ä¸»è¡¨å…³è”çš„æ•°æ®,åˆ™ä¸»è¡¨ä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤,ä½†æ˜¯CASCADEä¼šå…ˆæ¨¡æ‹Ÿåˆ äº†ä»è¡¨,å†å»åˆ ä¸»è¡¨
  2. models.PEOTECT æŠ›å‡ºProtectedError ä»¥é˜»æ­¢è¢«å¼•ç”¨å¯¹è±¡çš„åˆ é™¤;
  3. models.SET_NULL è®¾ç½®ForeignKey null; éœ€è¦æŒ‡å®šnull=True;
  4. models.SET_DEFAULT å°†ForeignKey è®¾ç½®ä¸ºå…¶é»˜è®¤å€¼, å¿…é¡»è®¾ç½® ForeignKey çš„é»˜è®¤å€¼.
  ```

  å®˜ç½‘: https://docs.djangoproject.com/en/2.2/ref/models/fields/#foreignkey

  ```python
  # æ„å»ºä¸€ä¸ª å‡ºç‰ˆç¤¾, è·Ÿå›¾ä¹¦çš„ä¸€å¯¹å¤šçš„è¡¨
  from . import models
  pub1 = models.Publisher.objects.create(name='æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾')
  models.Book.objects.create(title='C++', publisher=pub1)
  models.Book.objects.create(title='Java', publisher=pub1)
  models.Book.objects.create(title='Python', publisher=pub1) 
  
  pub2 = models.Publisher.objects.create(name='åŒ—äº¬å¤§å­¦å‡ºç‰ˆç¤¾')
  models.Book.objects.create(title='è¥¿æ¸¸è®°', publisher=pub2)
  models.Book.objects.create(title='æ°´æµ’', publisher=pub2)
  ```

* æŸ¥è¯¢

  ```python
  # é€šè¿‡ä¸€æœ¬ä¹¦æ‰¾åˆ°å¯¹åº”çš„å‡ºç‰ˆç¤¾
  abook = models.Book.objects.get(id=1)
  print(abook.title, 'çš„å‡ºç‰ˆç¤¾æ˜¯:', abook.publisher.name)
  ```

  ```python
  # é€šè¿‡å‡ºç‰ˆç¤¾æŸ¥è¯¢å¯¹åº”çš„ä¹¦
  pub1 = models.Publisher.objects.get(name='æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾')
  # pubä¸€å¼€å§‹å…³è”ä¹‹åå°±èƒ½å¤Ÿæœ‰ä¸€ä¸ªå…³äºbook çš„å¯¹è±¡,å¹¶ä¸”ç³»ç»Ÿé»˜è®¤ä¸º book_set,å¯ä»¥é€šè¿‡book_setè°ƒç”¨ç›¸å…³çš„å¯¹è±¡
  books = pub1.book_set.all()  # é€šè¿‡book_set è·å–pub1å¯¹åº”çš„å¤šä¸ªBookæ•°æ®å¯¹è±¡
  
  # books = models.Book.objects.filter(publisher=pub1)  # ä¹Ÿå¯ä»¥é‡‡ç”¨æ­¤æ–¹å¼è·å–
  print("æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾çš„ä¹¦æœ‰:")
  for book in books:
      print(book.title)
  ```

* æ•°æ®æŸ¥è¯¢

  1. é€šè¿‡ Book æŸ¥è¯¢ Publisher

     ```python
     é€šè¿‡ publisher å±æ€§æŸ¥è¯¢å³å¯
     ç»ƒä¹ :
         æŸ¥è¯¢ è¥¿æ¸¸è®° å¯¹åº”çš„å‡ºç‰ˆç¤¾ä¿¡æ¯,æ‰“å°åœ¨ç»ˆç«¯ä¸Š
     ```

  2. é€šè¿‡ Publisher æŸ¥è¯¢ å¯¹åº”çš„æ‰€æœ‰çš„ Books

     ```python
     Djangoä¼šåœ¨Publisherä¸­å¢åŠ ä¸€ä¸ªå±æ€§æ¥è¡¨ç¤ºå¯¹å¯¹åº”çš„Bookä»¬çš„æŸ¥è¯¢å¼•ç”¨
     å±æ€§:book_set(MyModel.objects) # åå‘æŸ¥è¯¢æ—¶ç”¨ä¸Š, æ­£å‘æ²¡æœ‰
     ```

  ### 

### å¤šå¯¹å¤šæ˜ å°„

å¤šå¯¹å¤šåŒæ–¹éƒ½æ‹¥æœ‰å¯¹æ–¹çš„Managerç®¡ç†å™¨å¯ä»¥ è¿›è¡ŒæŸ¥è¯¢

```python
 authors = models.Author.objects.all()
 authors.book_set.count() # æ‹¥æœ‰åå‘ book_set
 books = models.Book.objects.all()
 auths = book.author.all() # æ­£å‘æ‹¥æœ‰ author
```

* è¯­æ³•

  ```python
  # åœ¨å…³è”çš„ä¸¤ä¸ªç±»ä¸­çš„ä»»æ„ä¸€ä¸ªç±»ä¸­,å¢åŠ 
  å±æ€§ = models.ManyToManyField(MyModel)
  ```

* e.g

  ```python
  # ä¸€ä¸ªä½œè€…å‡ºç‰ˆå¤šæœ¬ä¹¦
  # ä¸€æœ¬ä¹¦å¤šä¸ªä½œè€…ç­¾å
  class Author(models.Model):
  		pass
  class Book(models.Model):
      author = models.ManyToManyField(Author)
  ```

* æ•°æ®æŸ¥è¯¢

  1. é€šè¿‡ Book æŸ¥è¯¢å¯¹åº”çš„æ‰€æœ‰çš„ Authors

     ```python
     book.authors.all() -> è·å– book å¯¹åº”çš„æ‰€æœ‰çš„authorçš„ä¿¡æ¯
     book.authors.filter(age__gt=80) -> è·å–bookå¯¹åº”çš„ä½œè€…ä¸­å¹´é¾„å¤§äº80å²çš„ä½œè€…çš„ä¿¡æ¯
     ```

  2. é€šè¿‡ Author æŸ¥è¯¢å¯¹åº”çš„æ‰€æœ‰çš„Books

     - Djangoä¼šç”Ÿæˆä¸€ä¸ªå…³è”å±æ€§ book_set ç”¨äºè¡¨ç¤ºå¯¹å¯¹åº”çš„bookçš„æŸ¥è¯¢å¯¹è±¡ç›¸å…³æ“ä½œ

     ```python
     # book_set å…¶å®å°±æ˜¯djangoç»™æä¾›çš„ä¸€ä¸ªå¯¹è±¡,æ–¹ä¾¿æ“ä½œ
     author.book_set.all()
     author.book_set.filter()
     author.book_set.create(...)  # åˆ›å»ºæ–°ä¹¦å¹¶è”ä½œç”¨author
     author.book_set.add(book)   # æ·»åŠ å·²æœ‰çš„ä¹¦ä¸ºå½“å‰ä½œè€…author
     author.book_set.clear()  # åˆ é™¤authoræ‰€æœ‰å¹¶è”çš„ä¹¦
     ```



## cookies å’Œ session (ä¸¤ä¸ªæ”¾ä¸€èµ·å°±æ˜¯ä¸€ç§å­˜å‚¨æŠ€æœ¯, å•ä¸ªsessionå°±æ˜¯ä¸€ä¸ªä¼šè¯)

## cookies

##### ä½œç”¨: 1.ä¿æŒä¼šè¯çŠ¶æ€(ç™»å½•çŠ¶æ€) 2.è´­ç‰©è½¦-æœªç™»å½•çŠ¶æ€ä¸‹ 3.æœç´¢å¼•æ“-è®°å½•æœç´¢è®°å½•

##### ç¼ºç‚¹: 1.æ•°æ®å­˜å‚¨åœ¨å®¢æˆ·ç«¯ 2.æ¯æ¬¡è¯·æ±‚ç½‘ç«™,è‡ªåŠ¨æäº¤å½“å‰ç½‘ç«™çš„cookie 3.ç½‘ç»œå¸¦å®½

* cookies æ˜¯ä¿å­˜åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸Šçš„å­˜å‚¨ç©ºé—´, é€šå¸¸ç”¨æ¥è®°å½•æµè§ˆå™¨ç«¯è‡ªå·±çš„ä¿¡æ¯å’Œå½“å‰çš„é“¾æ¥çš„ç¡®è®¤ä¿¡æ¯

* cookies åœ¨æµè§ˆå™¨ä¸ŠæŒ‰åŸŸåéš”ç¦»å­˜å‚¨, æ˜¯ä»¥é”®-å€¼å¯¹çš„å½¢å¼è¿›è¡Œå­˜å‚¨çš„, é”®å’Œå€¼éƒ½æ˜¯ä»¥ASCIIå­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨(ä¸èƒ½æ˜¯ä¸­æ–‡å­—ç¬¦ä¸²)

* cookies çš„å†…éƒ¨çš„æ•°æ®ä¼šåœ¨æ¯æ¬¡è®¿é—®æ­¤ç½‘å€æ—¶éƒ½ä¼šæºå¸¦åˆ°æœåŠ¡å™¨ç«¯, å¦‚æœcookiesè¿‡å¤§ä¼šé™ä½å“åº”é€Ÿåº¦

* åœ¨djangoæœåŠ¡å™¨ç«¯æ¥è®¾ç½®  è®¾ç½®æµè§ˆå™¨çš„COOKIE å¿…é¡»é€šè¿‡HttpResponse å¯¹è±¡æ¥å®Œæˆ

* HttpResponse å…³äºCOOKIE çš„æ–¹æ³•

  * ##### æ·»åŠ  \ ä¿®æ”¹COOKIE: HttpResponse.set_cookie(key, value='', max_age=None)

    * key : cookie çš„åå­—

    * value : cookie çš„å€¼
    * max_age : cookie å­˜æ´»æ—¶é—´, ç§’ä¸ºå•ä½
    * expires : å…·ä½“è¿‡æœŸæ—¶é—´
    * å½“ä¸æŒ‡å®šmax_age å’Œ expiresæ—¶, å…³é—­æµè§ˆå™¨æ—¶æ¬¡æ•°æ®å¤±æ•ˆ

  * ##### åˆ é™¤COOKIE

    * HttpResponse.delete_cookie(key)
    * åˆ é™¤æŒ‡å®šçš„key çš„Cookieã€‚ å¦‚æœkey ä¸å­˜åœ¨åˆ™ä»€ä¹ˆä¹Ÿä¸å‘ç”Ÿã€‚

  * ##### è·å–COOKIE

    ```python
    value = request.COOKIES.get('cookieså', 'æ²¡æœ‰å€¼!')
    ```

  * Djangoä¸­çš„cookies  ä½¿ç”¨å“åº”å¯¹è±¡HttpResponse ç­‰ å°†cookieä¿å­˜è¿›å®¢æˆ·ç«¯

  1. æ–¹æ³•1

     ```python
     from django.http import HttpResponse
     resp = HttpResponse()
     resp.set_cookie('cookieså', cookieså€¼, è¶…æœŸæ—¶é—´)
     
     resp = HttpResponse()
     resp.set_cookie('myvar', "weimz", è¶…æœŸæ—¶é—´)
     ```

  2. æ–¹æ³•2(ä½¿ç”¨renderå¯¹è±¡)

     ```python
     from django.shortcuts import render
     resp = render(request,'xxx.html',locals())
     resp.set_cookie('cookieså', cookieså€¼, è¶…æœŸæ—¶é—´)
     ```

  

## Session ä¼šè¯æ§åˆ¶

åœ¨æœåŠ¡å™¨ä¸Šå¼€è¾Ÿä¸€æ®µç©ºé—´ç”¨äºä¿ç•™æµè§ˆå™¨å’ŒæœåŠ¡å™¨äº¤äº’æ—¶çš„é‡è¦æ•°æ®

##### sessionçš„èµ·æº:

* httpåè®®æ˜¯æ— çŠ¶æ€çš„: æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€æ¬¡æ–°çš„è¯·æ±‚, ä¸ä¼šè®°å¾—ä¹‹å‰é€šä¿¡çš„çŠ¶æ€
* å®ç°çŠ¶æ€ä¿æŒçš„æ–¹å¼: åœ¨å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ç«¯å­˜å‚¨ä¼šè¯æœ‰å…³çš„æ•°æ®
* æ¨èä½¿ç”¨sessionæ–¹å¼, æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯

##### å®ç°æ–¹å¼:

* ä½¿ç”¨sessionéœ€è¦åœ¨æµè§ˆå™¨å®¢æˆ·ç«¯å¯åŠ¨cookie, ä¸”ç”¨åœ¨cookieä¸­å­˜å‚¨sessionid
* æ¯ä¸ªå®¢æˆ·ç«¯éƒ½å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æœ‰ä¸€ä¸ªç‹¬ç«‹çš„session
* ä¸åŒè¯·æ±‚è€…ä¸ä¼šå…±äº«è¿™ä¸ªæ•°æ®, ä¸è¯·æ±‚è€…ä¸€ä¸€å¯¹åº”

##### djangoå¯ç”¨session

* settings.pyä¸­installed_appsä¸­æ·»åŠ 

```python
INSTALLED_APPS = [
		# å¯ç”¨sessions åº”ç”¨
		'django.contrib.sessions',
]
```

* å‘middleware_classesåˆ—è¡¨ä¸­æ·»åŠ :

```python
MIDDLEWARE = [
		# å¯ç”¨sessionä¸­é—´ä»¶
  	'django.contrib.sessions.middleware.SessionMiddleware',
]
```

* sessionçš„åŸºæœ¬æ“ä½œ:

  * sessionå¯¹è±¡æ˜¯ä¸€ä¸ªåœ¨ç±»ä¼¼äºå­—å…¸çš„ sessionstore ç±»å‹çš„å¯¹è±¡, å¯ä»¥ç”¨ç±»ä¼¼äºå­—å…¸çš„æ–¹å¼è¿›è¡Œæ“ä½œ
  * sessionåªèƒ½å¤Ÿå­˜å‚¨åºåˆ—åŒ–çš„æ•°æ®, å¦‚: å­—å…¸ . åˆ—è¡¨ç­‰

  1. ä¿å­˜session çš„å€¼åˆ°æœåŠ¡å™¨

  ```python
  request.session['KEY'] = value
  # request.session æ˜¯ä¸€ä¸ªå­—å…¸
  ```

  2. è·å–sessionçš„å€¼

  ```python
  value = request.session['KEY']
  value = request.session.get('KEY', ç¼ºçœå€¼)
  ```

  3. åˆ é™¤sessionçš„å€¼

  ```python
  del request.session['KEY']
  ```

* settings.py ä¸­æœ‰å…³sessionçš„è®¾ç½®

  1. SESSIOIN_COOKIE_AGE

     * æŒ‡å®šsessionidåœ¨cookiesä¸­çš„ä¿å­˜æ—¶é•¿(é»˜è®¤2å‘¨)

     ```python
     SESSION_COOKIE_AGE = 60*60*24*7*2
     ```

  2. SESSION_EXPIRE_AT_BROWSER_CLOSE = True

     è®¾ç½®åªè¦æµè§ˆå™¨å…³é—­æ—¶, sessionå°±å¤±æ•ˆ(é»˜è®¤False)

* sessionç¼ºçœé…ç½®

  * æ¨¡å—:

  ```python
  import django.conf.global_settings
  ```

* ä½¿ç”¨sessionæ—¶éœ€è¦è¿ç§»æ•°æ®åº“, å¦åˆ™ä¼šå‡ºç°é”™è¯¯

  ```python
  python3 manage.py makemigrations
  python3 manage.py migrate
  ```

* ### session å•è¡¨é—®é¢˜

  1. django æ‰€æœ‰ session æ•°æ®å­˜å‚¨åœ¨å•ä¸ªè¡¨ä¸­, è¡¨åä¸ºdjango_session,å¹¶ä¸”è¯¥è¡¨æ²¡æœ‰è‡ªåŠ¨å›æ”¶[ è¿‡æœŸçš„session ], å¯æ‰§è¡Œ python3 manage.py clearsessions è¿›è¡Œè¿‡æœŸsessionçš„åˆ é™¤



## ç¼“å­˜

ä¸€ç±»å¯ä»¥æ›´å¿«çš„è¯»å–æ•°æ®çš„ä»‹è´¨ç»Ÿç§°, ä¹ŸæŒ‡å…¶ä»–å¯ä»¥åŠ å¿«æ•°æ®è¯»å–çš„å­˜å‚¨æ–¹å¼. ä¸€èˆ¬ç”¨æ¥å­˜å‚¨ä¸´æ—¶æ•°æ®, å¸¸ç”¨ä»‹è´¨æ˜¯è¯»å–é€Ÿåº¦å¾ˆå¿«çš„å†…å­˜

è§†å›¾æ¸²æŸ“æœ‰ä¸€å®šæˆæœ¬, å¯¹äºä½é¢‘å˜åŠ¨çš„é¡µé¢å¯ä»¥è€ƒè™‘ä½¿ç”¨ç¼“å­˜æŠ€æœ¯, å‡å°‘å®é™…æ¸²æŸ“æ¬¡æ•°

```python
# æ¡ˆä¾‹
from django.shortcuts import render
def index(request):
		# æ—¶é—´å¤æ‚åº¦æé«˜çš„æ¸²æŸ“
		book_list = Book.objects.all() # å‡è®¾2s
		return render(request, 'index.html', locals())
```

```python
# ä¼˜åŒ–
given a URL, try finding that page in the cache
if the page is in the cache:
  	return the cached page
else:
  	generate the page
    save the generated page in the cache (for next time)
    return the generated page
```

ä½¿ç”¨åœºæ™¯:

1. åšå®¢åˆ—è¡¨é¡µ 2. ç”µå•†è¯¦æƒ…é¡µ 3. ç¼“å­˜å¯¼èˆªåŠé¡µè„š

## djangoç¼“å­˜è®¾ç½®

djangoä¸­æä¾›å¤šç§ç¼“å­˜æ–¹å¼, å¦‚æœéœ€ä½¿ç”¨éœ€è¦åœ¨settings.pyä¸­è¿›è¡Œé…ç½®

1. ##### æ•°æ®åº“ç¼“å­˜

   djangoå¯ä»¥å°†å…¶ç¼“å­˜çš„æ•°æ®å­˜å‚¨åœ¨æ‚¨çš„æ•°æ®åº“ä¸­

   ```python
   CACHES = {
     	'default': {
   			'BACKEND': 'django.core.cache.backends.db.DatabaseCache',
   			'LOCATION': 'my_cache_table',
   			'OPTIONS': {'MAX_ENTRIES': 300, 'CULL_FREQUENCY': 2, }
         # 300æ˜¯å…è®¸å­˜å‚¨300æ¡æ•°æ®, æ»¡äº†æ‰§è¡Œåˆ é™¤, 2 ä»£è¡¨åˆ é™¤1/2, éƒ½å¯ä»¥è‡ªå·±è®¾å®š
       }
   }
   ```

   åˆ›å»ºç¼“å­˜è¡¨

   ```shell
   python3 manage.py createcachetable
   ```

2. æ–‡ä»¶ç³»ç»Ÿç¼“å­˜

   ```python
   CACHES = {
   		'default': {
   				'BACKEND': 'django.core.cache.backends.filedbased.FileBasedCache',
   				'LOCATION': '/var/tmp/django_cache', # æ–‡ä»¶å¤¹è·¯å¾„
   				
   		}
   ```

3. æœ¬åœ°å†…å­˜ç¼“å­˜

   ```python
   CACHES = {
   		'default': {
   				'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
   				'LOCATION': 'unique-snowflake', # é›ªèŠ±ç®—æ³•
   		}
   }
   ```

## Djangoä¸­ä½¿ç”¨ç¼“å­˜

* åœ¨è§†å›¾Viewä¸­ä½¿ç”¨
* åœ¨è·¯ç”±URLä¸­ä½¿ç”¨
* åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨

åœ¨è§†å›¾Viewä¸­ä½¿ç”¨cache

```python
from django.views.decorators.cache import cache_page

@cache_page(30)  # ç§’ä¸ºå•ä½
def my_view(request):
  	...
```

åœ¨è·¯ç”±ä¸­ä½¿ç”¨

```python
from django.views.decorators.cache import cache_page
urlpatterns = [
  	re_path('foo/', cache_page(60)(my_view)),
]
```

åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨

```python
{% load cache %}
{% cache 500 sidebar request.user.username %} # ç›¸å½“äºç¼“å­˜æ˜¯ sidebar_request.user.username æ‰€ä»¥æ¯æ¬¡æ–°çš„ç”¨æˆ·æ¥, ç¼“å­˜ä¸ä¼šç›¸åŒ
		...sidebar for logged in user...
{% endcache %}

e.g
{% load cache %}
{% cache 30 test_t %}
xxxxx
{% endcache %}
```



## æµè§ˆå™¨ä¸­çš„ç¼“å­˜

ç¼“å­˜åˆ†ç±»: 

### å¼ºç¼“å­˜ : ä¸ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚, ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–èµ„æº

1. Expires: ç¼“å­˜è¿‡æœŸæ—¶é—´, ç”¨æ¥æŒ‡å®šèµ„æºåˆ°æœŸçš„æ—¶é—´, æ˜¯æœåŠ¡å™¨ç«¯çš„å…·ä½“çš„æ—¶é—´ç‚¹ Expires=max-age + è¯·æ±‚æ—¶é—´

   Expiresæ˜¯HTTP/1çš„äº§ç‰©, å—é™äºæœ¬åœ°æ—¶é—´, å¦‚æœä¿®æ”¹äº†æœ¬åœ°æ—¶é—´, å¯èƒ½ä¼šé€ æˆç¼“å­˜å¤±è´¥

2. Cache-Control: åœ¨HTTP/1.1ä¸­, Cache-Controlä¸»è¦ç”¨äºæ§åˆ¶ç½‘é¡µç¼“å­˜. æ¯”å¦‚å½“Cache-Control:max-age=120 ä»£è¡¨è¯·æ±‚åˆ›å»ºæ—¶é—´åçš„120ç§’, ç¼“å­˜å¤±æ•ˆ
3. 

### åå•†ç¼“å­˜ : å¼ºç¼“å­˜å¤±æ•ˆå, æµè§ˆå™¨æºå¸¦ç¼“å­˜æ ‡è¯†å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚, ç”±æœåŠ¡å™¨æ ¹æ®ç¼“å­˜æ ‡è¯†å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„è¿‡ç¨‹

1. Last-Modified å’Œ If-Modified-Since

   ç¬¬ä¸€æ¬¡è®¿é—®æ—¶, æœåŠ¡å™¨ä¼šè¿”å› Last-Modified : Fri,22 Jul 2016 01:47:00 GMT

   æµè§ˆå™¨ä¸‹æ¬¡è¯·æ±‚æ—¶ æºå¸¦If-Modified-Since è¿™ä¸ªheader, è¯¥å€¼ä¸ºLast-Modified, æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚å, å¯¹æ¯”ç»“æœ, è‹¥èµ„æºæœªå‘ç”Ÿæ”¹å˜, åˆ™è¿”å›304, å¦åˆ™è¿”å›200å¹¶å°†æ–°èµ„æºè¿”å›ç»™æµè§ˆå™¨

   ç¼ºç‚¹ : åªèƒ½ç²¾ç¡®åˆ°ç§’, å®¹æ˜“å‘ç”Ÿå•ç§’å†…å¤šæ¬¡ä¿®æ”¹, æ£€æµ‹ä¸åˆ°.

2. ETag å’Œ If-None-Match

   ETagæ˜¯æœåŠ¡å™¨å“åº”è¯·æ±‚æ—¶, è¿”å›å½“å‰èµ„æºæ–‡ä»¶çš„ä¸€ä¸ªå”¯ä¸€æ ‡è¯†( ç”±æœåŠ¡å™¨ç”Ÿæˆ ), åªè¦èµ„æºæœ‰å˜åŒ–, ETagå°±ä¼šé‡æ–°ç”Ÿæˆ

   æµç¨‹åŒä¸Š 

   å¯¹æ¯”Last-Modified VS ETag

   1. ç²¾åº¦ä¸ä¸€æ · - ETag é«˜
   2. æ€§èƒ½ä¸Š - Last-Modifi é«˜
   3. ä¼˜å…ˆçº§ - Etag é«˜

æé—®æµè§ˆå™¨æ¯æ¬¡å†³å®šæ˜¯å¦ç¼“å­˜?

**æµè§ˆå™¨æ€ä¹ˆç¡®å®šä¸€ä¸ªèµ„æºè¯¥ä¸è¯¥ç¼“å­˜ï¼Œå¦‚ä½•å»ç¼“å­˜å‘¢**ï¼Ÿæµè§ˆå™¨ç¬¬ä¸€æ¬¡å‘æœåŠ¡å™¨å‘èµ·è¯¥è¯·æ±‚åæ‹¿åˆ°è¯·æ±‚ç»“æœåï¼Œå°†è¯·æ±‚ç»“æœå’Œç¼“å­˜æ ‡è¯†å­˜å…¥æµè§ˆå™¨ç¼“å­˜ï¼Œ**æµè§ˆå™¨å¯¹äºç¼“å­˜çš„å¤„ç†æ˜¯æ ¹æ®ç¬¬ä¸€æ¬¡è¯·æ±‚èµ„æºæ—¶è¿”å›çš„å“åº”å¤´æ¥ç¡®å®šçš„**ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![img](https:////upload-images.jianshu.io/upload_images/3174701-de3d6e025582103a?imageMogr2/auto-orient/strip|imageView2/2/w/670)

ç¬¬ä¸€æ¬¡å‘èµ·HTTPè¯·æ±‚

ç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š

- æµè§ˆå™¨æ¯æ¬¡å‘èµ·è¯·æ±‚ï¼Œéƒ½ä¼šå…ˆåœ¨æµè§ˆå™¨ç¼“å­˜ä¸­æŸ¥æ‰¾è¯¥è¯·æ±‚çš„ç»“æœä»¥åŠç¼“å­˜æ ‡è¯†
- æµè§ˆå™¨æ¯æ¬¡æ‹¿åˆ°è¿”å›çš„è¯·æ±‚ç»“æœéƒ½ä¼šå°†è¯¥ç»“æœå’Œç¼“å­˜æ ‡è¯†å­˜å…¥æµè§ˆå™¨ç¼“å­˜ä¸­



## ç”¨æˆ·è¡Œä¸ºå¯¹æµè§ˆå™¨ç¼“å­˜çš„å½±å“

æ‰€è°“ç”¨æˆ·è¡Œä¸ºå¯¹æµè§ˆå™¨ç¼“å­˜çš„å½±å“ï¼ŒæŒ‡çš„å°±æ˜¯ç”¨æˆ·åœ¨æµè§ˆå™¨å¦‚ä½•æ“ä½œæ—¶ï¼Œä¼šè§¦å‘æ€æ ·çš„ç¼“å­˜ç­–ç•¥ã€‚ä¸»è¦æœ‰ 3 ç§ï¼š

- æ‰“å¼€ç½‘é¡µï¼Œåœ°å€æ è¾“å…¥åœ°å€ï¼š æŸ¥æ‰¾ disk cache ä¸­æ˜¯å¦æœ‰åŒ¹é…ã€‚å¦‚æœ‰åˆ™ä½¿ç”¨ï¼›å¦‚æ²¡æœ‰åˆ™å‘é€ç½‘ç»œè¯·æ±‚ã€‚
- æ™®é€šåˆ·æ–° (F5)ï¼šå› ä¸º TAB å¹¶æ²¡æœ‰å…³é—­ï¼Œå› æ­¤ memory cache æ˜¯å¯ç”¨çš„ï¼Œä¼šè¢«ä¼˜å…ˆä½¿ç”¨(å¦‚æœåŒ¹é…çš„è¯)ã€‚å…¶æ¬¡æ‰æ˜¯ disk cacheã€‚
- å¼ºåˆ¶åˆ·æ–° (Ctrl + F5)ï¼šæµè§ˆå™¨ä¸ä½¿ç”¨ç¼“å­˜ï¼Œå› æ­¤å‘é€çš„è¯·æ±‚å¤´éƒ¨å‡å¸¦æœ‰ `Cache-control: no-cache`(ä¸ºäº†å…¼å®¹ï¼Œè¿˜å¸¦äº† `Pragma: no-cache`),æœåŠ¡å™¨ç›´æ¥è¿”å› 200 å’Œæœ€æ–°å†…å®¹ã€‚



æ€»ç»“(é¢è¯•): 

1. æµè§ˆå™¨ - å‘å‡ºè¯·æ±‚æ—¶[ æµè§ˆå™¨åœ°å€æ å›æ’¤/æ‘çº½/è¶…é“¾æ¥-GET ], æµè§ˆå™¨ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¼ºç¼“å­˜
   1. å¦‚æœæ²¡æœ‰å¼ºç¼“å­˜, æµè§ˆå™¨å‘å‡ºhttpè¯·æ±‚è‡³æœåŠ¡å™¨ç«¯
   2. æœ‰å¼ºç¼“å­˜, ä½†æ˜¯ç¼“å­˜è¿‡æœŸ: å°è¯•åå•†ç¼“å­˜-[Last_Modified/ETag]
      1. Last_Modified : æŠŠä¸Šæ¬¡ç¼“å­˜å“åº”å¤´ä¸­çš„Last_Modifiedçš„å€¼èµ‹å€¼ç»™If-Modified-Since è¯·æ±‚å¤´, å‘é€è‡³æœåŠ¡å™¨; å¦‚æœæœåŠ¡å™¨ç«¯å¯¹æ¯”å½“å‰å“åº”çš„Modifiedå’Œè¯·æ±‚å¤´ä¸­ä¸€è‡´, åˆ™è¿”å›304ä¸”å“åº”ä½“ä¸ºç©º; å¦åˆ™è¿”å›200ä¸”å“åº”ä¸­æºå¸¦æœ€æ–°æ•°æ®
      2. Etag : æŠŠä¸Šæ¬¡ç¼“å­˜å“åº”å¤´ä¸­çš„Etagçš„å€¼èµ‹å€¼ç»™If-None-Match è¯·æ±‚å¤´, å‰©ä½™æ­¥éª¤åŒä¸Š



## ä¸­é—´ä»¶ Middleware 

* ä¸­é—´ä»¶æ˜¯django è¯·æ±‚/å“åº”å¤„ç†çš„é’©å­æ¡†æ¶. å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€ä½çº§çš„'æ’ä»¶'ç³»ç»Ÿ, ç”¨äºå…¨å±€æ”¹å˜djangoçš„è¾“å…¥æˆ–è¾“å‡º

* æ¯ä¸ªä¸­é—´ä»¶ç»„ä»¶è´Ÿè´£åšä¸€äº›ç‰¹å®šçš„åŠŸèƒ½. ä¾‹å¦‚, djangoåŒ…å«ä¸€ä¸ªä¸­é—´ä»¶ç»„ä»¶ AuthenticationMiddleware, å®ƒä½¿ç”¨ä¼šè¯å°†ç”¨æˆ·è¯·æ±‚å…³è”èµ·æ¥

* å®ƒçš„æ–‡æ¡£è§£é‡Šäº†ä¸­é—´ä»¶æ˜¯å¦‚ä½•å·¥ä½œçš„, å¦‚ä½•æ¿€æ´»ä¸­é—´ä»¶, ä»¥åŠå¦‚ä½•ç¼–å†™è‡ªå·±çš„ä¸­é—´ä»¶. Django å…·æœ‰ä¸€äº›å†…ç½®çš„ä¸­é—´ä»¶, ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨. ä»–ä»¬è¢«è®°å½•åœ¨ built-in middleware reference ä¸­

* ä¸­é—´ä»¶ç±»:

  * ä¸­é—´ä»¶ç±»é¡»ç»§æ‰¿è‡ª

    ```python
    django.utils.deprecation.MiddlewareMixin ç±»
    ```

  * ä¸­é—´ä»¶ç±»å¿…é¡»å®ç°ä¸‹åˆ—äº”ä¸ªæ–¹æ³•ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ª:

    ```python
    # æ‰§è¡Œè·¯ç”±ä¹‹å‰è¢«è°ƒç”¨, åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨, è¿”å›Noneæˆ–HttpRespenseå¯¹è±¡
    def process_request(self, request):
    		pass
    		
    # è°ƒç”¨è§†å›¾ä¹‹å‰è¢«è°ƒç”¨, åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨, è¿”å›Noneæˆ–HttpResponseå¯¹è±¡
    def process_view(self, request, callback, callback_args, callback_kwargs): # åé¢å‡ ä¸ªæ˜¯å…³é”®å­—ã€ä½ç½®ä¼ å‚
    		pass
    
    # æ‰€æœ‰å“åº”è¿”å›æµè§ˆå™¨,è¢«è°ƒç”¨,åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨,è¿”å›HttpResponseå¯¹è±¡
    def process_response(self, request, response):
    		pass
    		
    # å½“å¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶è°ƒç”¨,è¿”å›ä¸€ä¸ªHttpResponseå¯¹è±¡
    def process_exception(self, request, exception):
    		pass
    
    # åœ¨è§†å›¾åˆšå¥½æ‰§è¡Œå®Œæ¯•åè¢«è°ƒç”¨,åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨,è¿”å›å®ç°äº†renderæ–¹æ³•çš„å“åº”å¯¹è±¡
    def process_template_response(self, request, response):
      	pass
    ```

  Tips: 

  ```python
  request.META['REMOTE_ADDR']  # å¯ä»¥å¾—åˆ°è¿œç¨‹å®¢æˆ·ç«¯çš„ipåœ°å€
  request.path_info  # å¯ä»¥å¾—åˆ°å®¢æˆ·ç«¯è®¿é—®çš„GETè¯·æ±‚è·¯ç”±ä¿¡æ¯
  ```

  ç»ƒä¹ : åˆ©ç”¨ä¸­é—´ä»¶å®ç°å¼ºåˆ¶æŸä¸ªipåœ°å€åªèƒ½å‘/test å‘é€5æ¬¡GETè¯·æ±‚

  ```python
  class MMW(MiddlewareMixin):
      visit_times = {}
  
      def process_request(self, request):
          # è¯·æ±‚åˆ°è¾¾urls.pyä¸»è·¯ç”±ä¹‹å‰è°ƒç”¨
          # è¿”å›None åˆ™è¯·æ±‚ç»§ç»­æ‰§è¡Œ
          # è¿”å›HttpResponse åˆ™è¯·æ±‚ç»ˆæ­¢,ç›´æ¥å“åº”
          if not re.match(r'^/index', request.path_info):
              return
  
          ip = request.META['REMOTE_ADDR']  # è·å–è®¿å®¢ipåœ°å€
          times = self.visit_times.get(ip, 0)
          self.visit_times[ip] = times + 1
          if times < 5:
              return
          return HttpResponse('è®¿é—®äº†'+str(times)+',è¢«ç¦æ­¢äº†')
          print('MMW process_request do ___')
  ```

  



## è·¨ç«™è¯·æ±‚ä¼ªé€ ä¿æŠ¤ CSRF

çœ‹çœ‹django æºç 

* è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»

  * æŸäº›æ¶æ„ç½‘ç«™ä¸ŠåŒ…å«é“¾æ¥ã€è¡¨å•æŒ‰é’®æˆ–è€…JavaScript, ä»–ä»¬ä¼šåˆ©ç”¨ç™»é™†è¿‡çš„ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­çš„è®¤è¯ä¿¡æ¯è¯•å›¾åœ¨ä½ çš„ç½‘ç«™ä¸Šå®ŒæˆæŸäº›æ“ä½œ å³ corss-site request forgey

* csrf ä¸­é—´ä»¶å’Œæ¨¡æ¿æ ‡ç­¾ æä¾›å¯¹è·¨ç«™è¯·æ±‚ä¼ªé€ ç®€å•æ˜“ç”¨çš„é˜²æŠ¤

* ä½œç”¨: ä¸è®©å…¶ä»–è¡¨å•æäº¤åˆ°æ¬¡djangoæœåŠ¡å™¨

* è§£å†³æ–¹æ¡ˆ:

  1. å–æ¶ˆcsrféªŒè¯(ä¸æ¨è)

     åˆ é™¤ settings.py ä¸­MIDDLEWARE ä¸­çš„ django.middleware.csrf.CsrfViewMiddleware çš„ä¸­é—´ä»¶

  2. é€šè¿‡éªŒè¯ csrf_token éªŒè¯

     ```python
     # éœ€è¦åœ¨è¡¨å•ä¸­å¢åŠ ä¸€ä¸ªæ ‡ç­¾
     {% csrf_token %}
     ```

å›é¡¾:

1. ç¼“å­˜

   1. åç«¯ç¼“å­˜: å°†å¤æ‚çš„è§†å›¾å‡½æ•°å¤„ç†ç»“æœæ”¾åˆ°å…¶ä»–å­˜å‚¨ä»‹è´¨ä¸­, å½“ç”¨æˆ·ä¸‹æ¬¡è®¿é—®è¯¥è§†å›¾å‡½æ•°æ—¶, å¯è·³è¿‡è§†å›¾å‡½æ•°ç›´æ¥å°†ç»“æœä»å­˜å‚¨ä»‹è´¨ä¸­è·å–å¹¶è¿”å›ç»™ç”¨æˆ·

   2. æµè§ˆå™¨ç¼“å­˜: 

      1. æ¯æ¬¡æµè§ˆå™¨å‘è¯·æ±‚, å…ˆæ‰¾æ‰¾è‡ªå·±æµè§ˆå™¨å†…éƒ¨çš„ç¼“å­˜åŒºåŸŸ, æœ‰æ²¡æœ‰æ•°æ®[ http://127.0.0.1:8000/note/list], å¦‚æœæ²¡æœ‰ç¼“å­˜, æ‰å‘å‡ºçœŸå®httpè¯·æ±‚- [ åå•†ç¼“å­˜[ åŸæ¥æœ‰å¼ºç¼“å­˜, ä½†æ˜¯æ­¤æ¬¡è¯·æ±‚æ£€æŸ¥ç¼“å­˜æ—¶, ç¼“å­˜è¿‡æœŸ & last_modified or Etag ç¡®è®¤]ã€ç¬¬ä¸€æ¬¡è¯·æ±‚è·å–æ•°æ® ]

      2. åå•†ç¼“å­˜ç»“æœ:

         304 ä»£è¡¨å½“å‰ç¼“å­˜èƒ½ç”¨, æ‚¨åœ¨ä½¿ç”¨ä¸€é˜µå­; å“åº”ä½“ä¸ºç©º

         200 ç¼“å­˜çš„ç¡®è®¤è¿‡æœŸäº†, å“åº”å…¨æ–°æ•°æ®

2. csrf è·¨ç«™ä¼ªé€ æ”»å‡»
   1. æ”»å‡»åŸç†: è€ç‹çœ‹ç›´æ’­æ¯å¤©
   2. djangoå¦‚ä½•é˜²èŒƒ: 
      1. ç¡®è®¤æ˜¯å¦å¼€å¯csrf ä¸­é—´ä»¶
      2. æ¨¡æ¿è¡¨å•ä¸­æ·»åŠ  æ ‡ç­¾ form æ ‡ç­¾å†… {% csrf_token %}
      3. cookies é‡Œé¢ æš—å·1 , è¡¨å•é‡Œé¢ æš—å·2; æœåŠ¡å™¨æ ¡éªŒ æš—å·1===æš—å·2, å¦‚æœæˆç«‹,åˆ™æ ¡éªŒé€šè¿‡, å¦åˆ™æ€€ç–‘æ˜¯csrfæ”»å‡»
3. ä¸­é—´ä»¶: åœ¨ä¸åŒèŠ‚ç‚¹è§¦å‘, è°ƒç”¨çš„ç±»



## åˆ†é¡µ

---

* åˆ†é¡µæ˜¯æŒ‡åœ¨webé¡µé¢æœ‰å¤§é‡æ•°æ®éœ€è¦æ˜¾ç¤º, ä¸ºäº†é˜…è¯»æ–¹ä¾¿åœ¨æ¯ä¸ªé¡µä¸­åªæ˜¾ç¤ºéƒ¨åˆ†æ•°æ®.
* å¥½å¤„:
  1. æ–¹ä¾¿é˜…è¯»
  2. å‡å°‘æ•°æ®æå–é‡, å‡è½»æœåŠ¡å™¨å‹åŠ›

* django æä¾›äº†Paginator ç±»å¯ä»¥æ–¹ä¾¿çš„å®ç°åˆ†é¡µåŠŸèƒ½
* Paginator ç±»ä½äºdjango.core.paginator æ¨¡å—ä¸­.

## Paginator å¯¹è±¡

* å¯¹è±¡æ„é€ æ–¹æ³•

  ```python
  Paginator(object_list, per_page)
  # object_list éœ€è¦åˆ†ç±»æ•°æ®çš„å¯¹è±¡åˆ—è¡¨
  # per_page æ¯é¡µæ•°æ®ä¸ªæ•°
  # è¿”å›å€¼: åˆ†é¡µå¯¹è±¡
  ```

* Paginator å±æ€§

  ```python
  count # éœ€è¦åˆ†ç±»æ•°æ®çš„å¯¹è±¡æ€»æ•°
  num_pages # åˆ†é¡µåçš„é¡µé¢æ€»æ•°
  page_range # ä»1å¼€å§‹çš„rangeå¯¹è±¡,ç”¨äºè®°å½•å½“å‰ç æ•° -> range(1,n)
  per_page # æ¯é¡µæ•°æ®çš„ä¸ªæ•°
  ```

* Paginator æ–¹æ³•

  ```python
  Paginator.page(number)
  # å‚æ•° number ä¸ºé¡µç ä¿¡æ¯(ä»1å¼€å§‹)
  # è¿”å›å½“å‰ number é¡µå¯¹åº”çš„é¡µä¿¡æ¯
  # å¦‚æœæä¾›çš„é¡µç ä¸å­˜åœ¨,æŠ›å‡ºInvalidPageå¼‚å¸¸
  ```

* Paginator å¼‚å¸¸ exception
  * InvalidPage : å½“å‘page( ) ä¼ å…¥ä¸€ä¸ªæ— æ•ˆçš„é¡µç æ—¶æŠ›å‡º
  * PageNotAnlnteger : å½“å‘page( ) ä¼ å…¥ä¸€ä¸ªä¸æ˜¯æ•´æ•°çš„å€¼æ—¶æŠ›å‡º
  * EmptyPage : å½“å‘page( ) æä¾›ä¸€ä¸ªæœ‰æ•ˆå€¼, ä½†æ˜¯é‚£ä¸ªé¡µé¢ä¸Šæ²¡æœ‰ä»»ä½•å¯¹è±¡æŠ›å‡º

## pageå¯¹è±¡

* åˆ›å»ºå¯¹è±¡: Paginator å¯¹è±¡çš„page()æ–¹æ³•, è¿”å›Pageå¯¹è±¡, ä¸éœ€è¦æ‰‹åŠ¨æ„é€ 

* Pageå¯¹è±¡å±æ€§ page = paginator.page(1)

  * object_list : å½“å‰é¡µä¸Šæ‰€æœ‰æ•°æ®å¯¹è±¡çš„åˆ—è¡¨
  * number : å½“å‰é¡µçš„åºå·, ä»1 å¼€å§‹
  * paginator : å½“å‰page å¯¹è±¡ç›¸å…³çš„Paginatorå¯¹è±¡

* Pageå¯¹è±¡æ–¹æ³•

  * has_next() : å¦‚æœæœ‰ä¸‹ä¸€é¡µè¿”å›True
  * has_previous() : å¦‚æœæœ‰ä¸Šä¸€é¡µè¿”å›True
  * has_other_number() : æœ‰å…¶ä»–é¡µè¿”å›True
  * next_page_number() : ä¸‹ä¸€é¡µé¡µç , ä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸InvalidPage
  * previous_page_number() : ä¸Šä¸€é¡µé¡µç , ä¸å­˜åœ¨æŠ›å‡ºå¼‚å¸¸InvalidPage

* Page å¯¹è±¡æ˜¯å¯è¿­ä»£å¯¹è±¡, å¯ä»¥ç”¨forè¯­å¥æ¥è®¿é—®å½“å‰é¡µé¢ä¸­çš„æ¯ä¸ªå¯¹è±¡

  

## æ–‡ä»¶ä¸Šä¼ 

---

* æ–‡ä»¶ä¸Šä¼ å¿…é¡»ä¸ºPOSTæäº¤æ–¹å¼

* è¡¨å•<form> ä¸­æ–‡ä»¶ä¸Šä¼ æ—¶å¿…é¡»å¸¦æœ‰enctype='multipart/form-data' æ—¶æ‰ä¼šåŒ…å«æ–‡ä»¶å†…å®¹æ•°æ®.

* è¡¨å•ä¸­ç”¨<input type='file' name='xxx'>æ ‡ç­¾ä¸Šä¼ æ–‡ä»¶

  * åå­—xxxå¯¹åº” request.FILES['xxx'] å¯¹åº”çš„å†…å­˜ç¼“å†²æ–‡ä»¶æµå¯¹è±¡. å¯é€šè¿‡ request.FILES['xxx'] è¿”å›çš„å¯¹è±¡è·å–ä¸Šä¼ æ–‡ä»¶æ•°æ®

  * file = request.FILES['xxx'] file ç»‘å®šæ–‡ä»¶æµå¯¹è±¡, å¯ä»¥é€šè¿‡æ–‡ä»¶æµå¯¹è±¡çš„å¦‚ä¸‹ä¿¡æ¯è·å–æ–‡ä»¶æ•°æ®

    ```python
    file = request.FILES['xxx']
    file.name # æ–‡ä»¶å
    file.file # æ–‡ä»¶çš„å­—èŠ‚æµæ•°æ®
    ```

* ä¸Šä¼ æ–‡ä»¶çš„è¡¨å•ä¹¦å†™æ–¹å¼

  ```Â html
  <!-- file: index/templates/index/upload.html -->
  <html>
  <head>
      <meta charset="utf-8">
      <title>æ–‡ä»¶ä¸Šä¼ </title>
  </head>
  <body>
      <h3>ä¸Šä¼ æ–‡ä»¶</h3>
      <form method="post" action="/upload" enctype="multipart/form-data">
          <input type="file" name="myfile"/><br>
          <input type="submit" value="ä¸Šä¼ ">
      </form>
  </body>
  </html>
  ```

* åœ¨setting.pyä¸­è®¾ç½®ä¸€ä¸ªå˜é‡MEDIA_ROOT ç”¨æ¥è®°å½•ä¸Šä¼ æ–‡ä»¶çš„ä½ç½®

  ```python
  # file : settings.py
  MEDIA_ROOT = os.path.join(BASE_DIR, 'static/files')
  ```

* åœ¨å½“å‰é¡¹ç›®æ–‡ä»¶å¤¹ä¸‹åˆ›å»º static/file æ–‡ä»¶å¤¹

  ```shell
  $ mkdir -p static/file
  ```

* æ·»åŠ è·¯ç”±åŠå¯¹åº”çš„å¤„ç†å‡½æ•°

  ```python
  # file views.py
  from django.http import HttpResponse, Http404
  from django.conf import settings
  import os
  
  def upload_view(request):
      if request.method == 'GET':
          return render(request, 'index/upload.html')
      elif request.method == "POST":
          a_file = request.FILES['myfile'] # è·å–æ–‡ä»¶æµå¯¹è±¡
          print("ä¸Šä¼ æ–‡ä»¶åæ˜¯:", a_file.name)
  
          filename =os.path.join(settings.MEDIA_ROOT, a_file.name)  #
          with open(filename, 'wb') as f:
              data = a_file.file.read()
              f.write(data)
          return HttpResponse("æ¥æ”¶æ–‡ä»¶:" + a_file.name + "æˆåŠŸ")
      raise Http404
  ```



## ç”ŸæˆCSVæ–‡ä»¶

---

 Djangoå¯ç›´æ¥åœ¨è§†å›¾å‡½æ•°ä¸­ç”Ÿæˆcsvæ–‡ä»¶ å¹¶å“åº”ç»™æµè§ˆå™¨

```python
def book_csv(request):
    # http://127.0.0.1:8000/index/book_csv?page=1
    # 1.æ”¹å“åº”å¤´ä¸­Content-Type
    res = HttpResponse(content_type='text/csv')
    # 2.å“åº”å¤´ä¸­æ·»åŠ ç‰¹æ®Šçš„é™„ä»¶å¤´
    res['Content-Disposition'] = 'attachment;filename=book.csv'

    # è·å–æ‰€æœ‰å¯¹è±¡
    all_book = Book.objects.all()
    # å¯¹æ‰€æœ‰å¯¹è±¡åˆ†é¡µ
    paginator = Paginator(all_book, 3)

    # è·å–æµè§ˆå™¨è¯·æ±‚çš„é¡µç 
    current_page = request.GET.get('page', 1)
    # å–å‡ºç›¸å¯¹é¡µç çš„ä¿¡æ¯
    page = paginator.page(current_page)

    # ç”Ÿæˆcsvçš„å†™å¯¹è±¡
    writer = csv.writer(res)
    # å†™æ•°æ®
    writer.writerow(['id', 'title'])
    for i in page:
        writer.writerow([i.id, i.title])
    return res
```

- å“åº”è·å¾—ä¸€ä¸ªç‰¹æ®Šçš„MIMEç±»å‹*text / csv*ã€‚è¿™å‘Šè¯‰æµè§ˆå™¨è¯¥æ–‡æ¡£æ˜¯CSVæ–‡ä»¶ï¼Œè€Œä¸æ˜¯HTMLæ–‡ä»¶
- å“åº”ä¼šè·å¾—ä¸€ä¸ªé¢å¤–çš„`Content-Disposition`æ ‡å¤´ï¼Œå…¶ä¸­åŒ…å«CSVæ–‡ä»¶çš„åç§°ã€‚å®ƒå°†è¢«æµè§ˆå™¨ç”¨äºâ€œå¦å­˜ä¸º...â€å¯¹è¯æ¡†
- å¯¹äºCSVæ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œï¼Œè°ƒç”¨`writer.writerow`ï¼Œä¼ é€’ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œå¦‚åˆ—è¡¨æˆ–å…ƒç»„ã€‚